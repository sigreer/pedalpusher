#!/usr/bin/env python3
"""
PedalPusher - USB foot pedal management utility.

Commands:
    reload      Reload configuration without restarting udevmon
    status      Show running filter status and PID
    log         Tail the pedalpusher log (journalctl)

Examples:
    pedalpusher reload
    pedalpusher status
    sudo pedalpusher reload  # May need sudo if running as different user
"""

import os
import signal
import subprocess
import sys


def find_filter_pid():
    """Find the PID of the running pedalpusher-filter process."""
    try:
        result = subprocess.run(
            ['pgrep', '-f', 'pedalpusher-filter'],
            capture_output=True, text=True
        )
        pids = [int(p) for p in result.stdout.strip().split('\n') if p]
        # Filter out our own process if we match
        pids = [p for p in pids if p != os.getpid()]
        return pids[0] if pids else None
    except Exception:
        return None


def cmd_reload():
    """Send SIGHUP to pedalpusher-filter to reload config."""
    pid = find_filter_pid()
    if not pid:
        print("Error: pedalpusher-filter is not running", file=sys.stderr)
        print("Start it with: sudo systemctl start udevmon", file=sys.stderr)
        return 1

    try:
        os.kill(pid, signal.SIGHUP)
        print(f"Sent SIGHUP to pedalpusher-filter (PID {pid})")
        print("Check reload status: sudo journalctl -u udevmon -n 10")
        return 0
    except PermissionError:
        print(f"Error: Permission denied sending signal to PID {pid}", file=sys.stderr)
        print("Try: sudo pedalpusher reload", file=sys.stderr)
        return 1
    except ProcessLookupError:
        print(f"Error: Process {pid} not found", file=sys.stderr)
        return 1


def cmd_status():
    """Show status of pedalpusher-filter."""
    pid = find_filter_pid()
    if pid:
        print(f"pedalpusher-filter is running (PID {pid})")

        # Try to get more info from /proc
        try:
            with open(f'/proc/{pid}/cmdline', 'r') as f:
                cmdline = f.read().replace('\0', ' ').strip()
                print(f"Command: {cmdline}")
        except Exception:
            pass

        # Check systemd status
        result = subprocess.run(
            ['systemctl', 'is-active', 'udevmon'],
            capture_output=True, text=True
        )
        print(f"udevmon service: {result.stdout.strip()}")
        return 0
    else:
        print("pedalpusher-filter is not running")
        result = subprocess.run(
            ['systemctl', 'is-active', 'udevmon'],
            capture_output=True, text=True
        )
        print(f"udevmon service: {result.stdout.strip()}")
        return 1


def cmd_log():
    """Tail the pedalpusher logs."""
    os.execlp('journalctl', 'journalctl', '-u', 'udevmon', '-f')


def cmd_help():
    """Show help."""
    print(__doc__)
    return 0


def main():
    commands = {
        'reload': cmd_reload,
        'status': cmd_status,
        'log': cmd_log,
        'help': cmd_help,
        '--help': cmd_help,
        '-h': cmd_help,
    }

    if len(sys.argv) < 2:
        cmd_help()
        return 1

    cmd = sys.argv[1]
    if cmd in commands:
        return commands[cmd]()
    else:
        print(f"Unknown command: {cmd}", file=sys.stderr)
        print("Use 'pedalpusher help' for usage", file=sys.stderr)
        return 1


if __name__ == '__main__':
    sys.exit(main() or 0)
